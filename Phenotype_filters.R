## Packages
library(ggplot2)
library(gridExtra)
library(reshape2)
library(data.table)
library(CMplot)
library(Hmisc)
library(cowplot)

dir <- "~/Dropbox/dropbox_work/data/biobank/"

## Phenotype filters####
bd <- read.table(paste0(dir,"ukb37327.tab"), head=TRUE, sep="\t")

lvl.0009 <- c(0,1)
lbl.0009 <- c("Female","Male")
bd$f.31.0.0 <- ordered(bd$f.31.0.0, levels=lvl.0009, labels=lbl.0009)
lvl.0008 <- c(1,2,3,4,5,6,7,8,9,10,11,12)
lbl.0008 <- c("January","February","March","April","May","June","July","August","September","October","November","December")
bd$f.52.0.0 <- ordered(bd$f.52.0.0, levels=lvl.0008, labels=lbl.0008)
bd$f.53.0.0 <- as.Date(bd$f.53.0.0)
bd$f.53.1.0 <- as.Date(bd$f.53.1.0)
bd$f.53.2.0 <- as.Date(bd$f.53.2.0)
bd$f.53.3.0 <- as.Date(bd$f.53.3.0)
bd$f.191.0.0 <- as.Date(bd$f.191.0.0)
lvl.100306 <- c(-3,-2,-1)
lbl.100306 <- c("Prefer not to answer","Never went to school","Do not know")
lvl.100508 <- c(-3,-1,1,2,3,4)
lbl.100508 <- c("Prefer not to answer","Do not know","Excellent","Good","Fair","Poor")
bd$f.2178.0.0 <- ordered(bd$f.2178.0.0, levels=lvl.100508, labels=lbl.100508)
bd$f.2178.1.0 <- ordered(bd$f.2178.1.0, levels=lvl.100508, labels=lbl.100508)
bd$f.2178.2.0 <- ordered(bd$f.2178.2.0, levels=lvl.100508, labels=lbl.100508)
bd$f.2178.3.0 <- ordered(bd$f.2178.3.0, levels=lvl.100508, labels=lbl.100508)
lvl.100570 <- c(-3,-1,1,2,3)
lbl.100570 <- c("Prefer not to answer","Do not know","Younger than average","About average age","Older than average")
bd$f.2385.0.0 <- ordered(bd$f.2385.0.0, levels=lvl.100570, labels=lbl.100570)
bd$f.2385.1.0 <- ordered(bd$f.2385.1.0, levels=lvl.100570, labels=lbl.100570)
bd$f.2385.2.0 <- ordered(bd$f.2385.2.0, levels=lvl.100570, labels=lbl.100570)
lvl.100291 <- c(-3,-1)
lbl.100291 <- c("Prefer not to answer","Do not know")
lvl.100349 <- c(-3,-1,0,1)
lbl.100349 <- c("Prefer not to answer","Do not know","No","Yes")
bd$f.2443.0.0 <- ordered(bd$f.2443.0.0, levels=lvl.100349, labels=lbl.100349)
bd$f.2443.1.0 <- ordered(bd$f.2443.1.0, levels=lvl.100349, labels=lbl.100349)
bd$f.2443.2.0 <- ordered(bd$f.2443.2.0, levels=lvl.100349, labels=lbl.100349)
bd$f.2443.3.0 <- ordered(bd$f.2443.3.0, levels=lvl.100349, labels=lbl.100349)
lvl.100584 <- c(-3)
lbl.100584 <- c("Prefer not to answer")
lvl.100582 <- c(-6,-3,-1)
lbl.100582 <- c("Irregular cycle","Prefer not to answer","Do not know")
bd$f.3799.0.0 <- ordered(bd$f.3799.0.0, levels=lvl.100349, labels=lbl.100349)
bd$f.3799.1.0 <- ordered(bd$f.3799.1.0, levels=lvl.100349, labels=lbl.100349)
bd$f.3799.2.0 <- ordered(bd$f.3799.2.0, levels=lvl.100349, labels=lbl.100349)
bd$f.3799.3.0 <- ordered(bd$f.3799.3.0, levels=lvl.100349, labels=lbl.100349)
lvl.100696 <- c(-1)
lbl.100696 <- c("Abandoned")
lvl.100305 <- c(-7,-3,1,2,3,4,5,6)
lbl.100305 <- c("None of the above","Prefer not to answer","College or University degree","A levels/AS levels or equivalent","O levels/GCSEs or equivalent","CSEs or equivalent","NVQ or HND or HNC or equivalent","Other professional qualifications eg: nursing, teaching")
bd$f.6138.0.0 <- ordered(bd$f.6138.0.0, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.0.1 <- ordered(bd$f.6138.0.1, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.0.2 <- ordered(bd$f.6138.0.2, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.0.3 <- ordered(bd$f.6138.0.3, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.0.4 <- ordered(bd$f.6138.0.4, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.0.5 <- ordered(bd$f.6138.0.5, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.1.0 <- ordered(bd$f.6138.1.0, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.1.1 <- ordered(bd$f.6138.1.1, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.1.2 <- ordered(bd$f.6138.1.2, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.1.3 <- ordered(bd$f.6138.1.3, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.1.4 <- ordered(bd$f.6138.1.4, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.1.5 <- ordered(bd$f.6138.1.5, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.2.0 <- ordered(bd$f.6138.2.0, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.2.1 <- ordered(bd$f.6138.2.1, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.2.2 <- ordered(bd$f.6138.2.2, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.2.3 <- ordered(bd$f.6138.2.3, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.2.4 <- ordered(bd$f.6138.2.4, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.2.5 <- ordered(bd$f.6138.2.5, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.3.0 <- ordered(bd$f.6138.3.0, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.3.1 <- ordered(bd$f.6138.3.1, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.3.2 <- ordered(bd$f.6138.3.2, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.3.3 <- ordered(bd$f.6138.3.3, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.3.4 <- ordered(bd$f.6138.3.4, levels=lvl.100305, labels=lbl.100305)
bd$f.6138.3.5 <- ordered(bd$f.6138.3.5, levels=lvl.100305, labels=lbl.100305)
lvl.0013 <- c(-3,-1)
lbl.0013 <- c("Preferred not to answer","Date uncertain or unknown")
lvl.1543 <- c(0,1,2)
lbl.1543 <- c("non-myopic","moderate/low myopia","highly myopic")
bd$f.20262.0.0 <- ordered(bd$f.20262.0.0, levels=lvl.1543, labels=lbl.1543)
lvl.1001 <- c(-3,-1,1,2,3,4,5,6,1001,1002,1003,2001,2002,2003,2004,3001,3002,3003,3004,4001,4002,4003)
lbl.1001 <- c("Prefer not to answer","Do not know","White","Mixed","Asian or Asian British","Black or Black British","Chinese","Other ethnic group","British","Irish","Any other white background","White and Black Caribbean","White and Black African","White and Asian","Any other mixed background","Indian","Pakistani","Bangladeshi","Any other Asian background","Caribbean","African","Any other Black background")
bd$f.21000.0.0 <- ordered(bd$f.21000.0.0, levels=lvl.1001, labels=lbl.1001)
bd$f.21000.1.0 <- ordered(bd$f.21000.1.0, levels=lvl.1001, labels=lbl.1001)
bd$f.21000.2.0 <- ordered(bd$f.21000.2.0, levels=lvl.1001, labels=lbl.1001)
bd$f.22001.0.0 <- ordered(bd$f.22001.0.0, levels=lvl.0009, labels=lbl.0009)
lvl.1002 <- c(1)
lbl.1002 <- c("Caucasian")
bd$f.22006.0.0 <- ordered(bd$f.22006.0.0, levels=lvl.1002, labels=lbl.1002)
lvl.0001 <- c(1)
lbl.0001 <- c("Yes")
bd$f.22019.0.0 <- ordered(bd$f.22019.0.0, levels=lvl.0001, labels=lbl.0001)
bd$f.22020.0.0 <- ordered(bd$f.22020.0.0, levels=lvl.0001, labels=lbl.0001)
lvl.0682 <- c(-1,0,1,10)
lbl.0682 <- c("Participant excluded from kinship inference process","No kinship found","At least one relative identified","Ten or more third-degree relatives identified")
bd$f.22021.0.0 <- ordered(bd$f.22021.0.0, levels=lvl.0682, labels=lbl.0682)
bd$f.22027.0.0 <- ordered(bd$f.22027.0.0, levels=lvl.0001, labels=lbl.0001)
lvl.100264 <- c(0,1)
lbl.100264 <- c("No","Yes")
bd$f.22028.0.0 <- ordered(bd$f.22028.0.0, levels=lvl.100264, labels=lbl.100264)
bd$f.22029.0.0 <- ordered(bd$f.22029.0.0, levels=lvl.100264, labels=lbl.100264)
bd$f.22030.0.0 <- ordered(bd$f.22030.0.0, levels=lvl.100264, labels=lbl.100264)
bd$f.40000.0.0 <- as.Date(bd$f.40000.0.0)
bd$f.40000.1.0 <- as.Date(bd$f.40000.1.0)
bd$f.40005.0.0 <- as.Date(bd$f.40005.0.0)
bd$f.40005.1.0 <- as.Date(bd$f.40005.1.0)
bd$f.40005.2.0 <- as.Date(bd$f.40005.2.0)
bd$f.40005.3.0 <- as.Date(bd$f.40005.3.0)
bd$f.40005.4.0 <- as.Date(bd$f.40005.4.0)
bd$f.40005.5.0 <- as.Date(bd$f.40005.5.0)
bd$f.40005.6.0 <- as.Date(bd$f.40005.6.0)
bd$f.40005.7.0 <- as.Date(bd$f.40005.7.0)
bd$f.40005.8.0 <- as.Date(bd$f.40005.8.0)
bd$f.40005.9.0 <- as.Date(bd$f.40005.9.0)
bd$f.40005.10.0 <- as.Date(bd$f.40005.10.0)
bd$f.40005.11.0 <- as.Date(bd$f.40005.11.0)
bd$f.40005.12.0 <- as.Date(bd$f.40005.12.0)
bd$f.40005.13.0 <- as.Date(bd$f.40005.13.0)
bd$f.40005.14.0 <- as.Date(bd$f.40005.14.0)
bd$f.40005.15.0 <- as.Date(bd$f.40005.15.0)
bd$f.40005.16.0 <- as.Date(bd$f.40005.16.0)
lvl.0261 <- c(1,2,7,19,55)
lbl.0261 <- c("IC Death Format (2011 and earlier)","IC Death Format (2012 onwards)","Scottish Morbidity Record (SMR)","Scottish Morbidity Record (SMR) 99B - 2015","IC Scottish deaths (2017 onwards)")
bd$f.40018.0.0 <- ordered(bd$f.40018.0.0, levels=lvl.0261, labels=lbl.0261)
bd$f.40018.1.0 <- ordered(bd$f.40018.1.0, levels=lvl.0261, labels=lbl.0261)
lvl.0272 <- c(1)
lbl.0272 <- c("Date is unknown")
bd$f.42020.0.0 <- as.Date(bd$f.42020.0.0)
bd$f.42032.0.0 <- as.Date(bd$f.42032.0.0)

## Write out non-sample-filtered phenotype file
#setwd("/Users/fruz0001/Documents/biobank/")
#write.table(bd,"pheno.txt",quote=F,row.names=F,sep="\t")

## Filter samples based on a number of different criteria

#Keep only unrelated individuals
bd1 <- subset(bd,f.22021.0.0=="No kinship found")
#Remove non-'White British ancestry' individuals
bd2 <- subset(bd1,f.22006.0.0=="Caucasian")
rm(bd1)
#Remove samples with high heterozygosity or missing rates
bd3 <- subset(bd2,is.na(f.22027.0.0))
rm(bd2)
#Remove samples where inferred sex does not match reported sex
bd4 <- subset(bd3,f.31.0.0==f.22001.0.0)
rm(bd3)
#Remove aneuploid samples
bd5 <- subset(bd4,is.na(f.22019.0.0))
rm(bd4)

## Write out sample-filtered phenotype file
#write.table(bd5,"pheno_filtered_v1.txt",quote=F,row.names=F,sep="\t")
#write.table(bd5[,c(1,1)],"indiv_filtered_v1.txt",quote=F,row.names=F,sep="\t",col.names=F)

#Only keep individuals aged 45 and above 
bd6 <- subset(bd5,f.21003.0.0>44)
rm(bd5)
#write.table(bd6,"pheno_filtered_v2.txt",quote=F,row.names=F,sep="\t")
#write.table(bd6[,c(1,1)],"indiv_filtered_v2.txt",quote=F,row.names=F,sep="\t",col.names=F)


#Replicate first column, for input into bolt-lmm
bd8 <- bd6[,c(1,1:ncol(bd6))]
names(bd8)[1:2] <- c("FID","IID")
rm(bd6)
rm(bd)

#Write out list of male and female ids
#write.table(bd8[bd8$f.31.0.0=="Male",c(1,2)],paste0(dir,"ukb_phenotypes/list_of_male_ids_v2.txt"),quote=F,row.names=F,col.names=F,sep=" ")
#write.table(bd8[bd8$f.31.0.0=="Female",c(1,2)],paste0(dir,"ukb_phenotypes/list_of_female_ids_v2.txt"),quote=F,row.names=F,col.names=F,sep=" ")
